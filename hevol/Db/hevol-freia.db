record (longin, "Cryo-HeVol:ReturnCnt") {
  field(DESC, "Returned GHe 1 count per 0.1 m³")
  field (SCAN, "10 second")
  field (INP, "HeliumVolume:In")
}
record (ao, "Cryo-HeVol:MagIns:Vol-1") {
  field(DESC, "Volume below the lambda plate")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "2.649")
  field(PINI, "YES")
}
record (ao, "Cryo-HeVol:MagIns:Vol-2") {
  field(DESC, "Volume above the lambda plate")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "0.712")
  field(PINI, "YES")
}
record (ao, "Cryo-HeVol:MagIns:VolGHe-4") {
  field(DESC, "Volume above LT683")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "0.155")
  field(PINI, "YES")
}

record (ao, "Cryo-HeVol:MagIns:VolGHe-5") {
  field(DESC, "Volume above 1st screen")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "0.347")
  field(PINI, "YES")
}
record (ao, "Cryo-HeVol:MagIns:VolGHe-6") {
  field(DESC, "Volume above 2nd screen")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "0.347")
  field(PINI, "YES")
}
record (ao, "Cryo-HeVol:MagIns:VolGHe-7") {
  field(DESC, "Volume above 3rd screen")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "0.262")
  field(PINI, "YES")
}

# Gas bag
#########################
record (ao, "Cryo-HeVol:GasBag:Vol") {
  field(DESC, "Max volume of the GasBag")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "100")
  field(PINI, "YES")
}

record (calc, "Cryo-HeVol:GasBag:VolGHe") {
  field(DESC, "GHe volume in the gas bag")
  field(SCAN, "10 second")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "70")
  field(INPB, "400")
  field(INPK, "Cryo-HeVol:GasBag:Vol")
  field(INPL, "Cryo-Rec:LP:GasBagLidar")
  field(CALC, "L<A?K:(L>=B?0:(B-L)/(B-A)*K)")
  field(FLNK, "Cryo-HeVol:GasBag:MassGHe")
}

record (calc, "Cryo-HeVol:GasBag:MassGHe") {
  field(DESC, "GHe mass in the gas bag")
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "0.163")
  field(INPL, "Cryo-HeVol:GasBag:VolGHe")
  field(CALC, "A*L")
}

##################################

# Buffer tank
#################################
record (ao, "Cryo-HeVol:BufTank:VolGHe") {
  field(DESC, "GHe volume of the buffer tank")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "30")
  field(PINI, "YES")
}

# GHe density at 300 K and 1 bar = 0.1598 kg/m3
record (calc, "Cryo-HeVol:BufTank:MassGHe") {
  field(DESC, "GHe mass in the buffer tank")
  field(SCAN, "10 second")
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA,"300.0")
  field(INPB,"273.15")
  field(INPC, "0.1598")
  field(INPJ,"Env-Container:TT001:sRdV")
  field(INPK,"Cryo-Cmp:HP:PI2170")
  field(INPL, "Cryo-HeVol:BufTank:VolGHe")
  field(CALC, "L*K*C*A/(B+J)")
}

#########################

# HP Storage
##################################

record (longout, "Cryo-HeVol:HPstorage:Bundles") {
  field(DESC, "Number of bundles in HP storage")
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:HPstorage:VolGHe")
}

record (calc, "Cryo-HeVol:HPstorage:VolGHe") {
  field(DESC, "GHe volume of the HP storage")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA,"Cryo-HeVol:HPstorage:Bundles")
  field(INPB,"0.6")
  field(CALC, "A*B")
}

record (calc, "Cryo-HeVol:HPstorage:MassGHe") {
  field(DESC, "GHe mass in the HP storage")
  field(SCAN, "10 second")
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA,"300.0")
  field(INPB,"273.15")
  field(INPC, "0.1598")
  field(INPJ,"Env-Container:TT001-smooth:sRdV")
  field(INPK,"Cryo-CBox:Pur:PI3404")
  field(INPL, "Cryo-HeVol:HPstorage:VolGHe")
  field(CALC, "L*K*C*A/(B+J)")
  field(FLNK, "Cryo-HeVol:HPstorage:LHeEquiv")
}

record (calc, "Cryo-HeVol:HPstorage:LHeEquiv") {
  field(DESC, "LHe equivalent (4.25K, 1 bar)")
  field(SCAN, "10 second")
  field(EGU, "l")
  field(PREC, 0)
#  field(INPA,"1000")
#  field(INPB,"273.15")
  field(INPC, "0.1244")
#  field(INPJ,"Env-Container:TT001:sRdV")
  field(INPL, "Cryo-HeVol:HPstorage:MassGHe")
  field(CALC, "L/C")
}

# PVs for He balance calculations
########

record (calcout, "Cryo-HeVol:HPstorage:InOut-Rst") {
  field(INPA, "Cryo-HeVol:Ctrl:Reset")
  field(CALC, "A=1?1:0")
  field(OUT, "Cryo-HeVol:HPstorage:InOut.OMSL")
  field(FLNK, "Cryo-HeVol:HPstorage:InOut.PROC")
}

record (ao, "Cryo-HeVol:HPstorage:InOut") {
  field(DESC, "Adding/removing from the cryo system")
  field(EGU, "m³")
  field(DOL, "Cryo-HeVol:Ctrl:Zero")
  field(UDFS, NO_ALARM)
  field(FLNK, "Cryo-HeVol:HPstorage:dMassHe.PROC")
}

record (calc, "Cryo-HeVol:HPstorage:dMassHe") {
  field(DESC, "LHe delivery(-) and return (+)")
  field(EGU, "kg")
  field(PREC, "1")
  field(PINI, YES)
  field(INPA, "300.0")
  field(INPB, "273.15")
  field(INPC, "0.1598")
  field(INPD, "Env-Container:TT001-smooth:sRdV")
  field(INPI, "Cryo-HeVol:Ctrl:Reset")
  field(INPJ, "Cryo-HeVol:HPstorage:dMassHe")
  field(INPL, "Cryo-HeVol:HPstorage:InOut")
  field(CALC, "I=1?0:L*C*A/(B+D)+J")
  info(autosaveFields,"VAL")
}


##################################
# Magnet Insert
##################################

record (calc, "Cryo-HeVol:MagIns:VolLHe-1") {
  field(DESC, "LHe volume below lambda plate")
  field(SCAN, "10 second")
  field(PHAS, "0")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:Foam-1:VolLHe")
  field(INPB, "Cryo-HeVol:Foam-2:VolLHe")
  field(INPC, "Cryo-HeVol:Magnet:VolLHe")
  field(INPD, "Cryo-HeVol:Foam-1:Volume")
  field(INPE, "Cryo-HeVol:Foam-2:Volume")
  field(INPF, "Cryo-HeVol:Magnet:Volume")
  field(INPG, "CstatV-Ctrl:MagIns:sInp")
  field(INPJ, "100.0")
  field(INPK, "Cryo-HeVol:MagIns:Vol-1")
  field(INPL, "CstatV-LHe:LI680:sRdV")
  field(CALC, "G=0?0:(L<0?0:(L>=100?K-D-E-F:K*L/J-A-B-C))")
  field(FLNK, "Cryo-HeVol:MagIns:VolGHe-1")
}

record (calc, "Cryo-HeVol:MagIns:VolGHe-1") {
  field(DESC, "GHe volume below lambda plate")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:MagIns:Vol-1")
  field(INPB, "Cryo-HeVol:MagIns:VolLHe-1")
  field(INPD, "Cryo-HeVol:Foam-1:Volume")
  field(INPE, "Cryo-HeVol:Foam-2:Volume")
  field(INPF, "Cryo-HeVol:Magnet:Volume")
  field(CALC, "A-D-E-F-B")
}

record (calc, "Cryo-HeVol:MagIns:VolLHe-2") {
  field(DESC, "LHe volume above lambda plate")
  field(SCAN, "10 second")
  field(PHAS, "0")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:Foam-3:VolLHe")
  field(INPB, "Cryo-HeVol:Foam-3:Volume")
  field(INPG, "CstatV-Ctrl:MagIns:sInp")
  field(INPJ, "100.0")
  field(INPK, "Cryo-HeVol:MagIns:Vol-2")
  field(INPL, "CstatV-LHe:LT682:sRdV")
  field(CALC, "G=0?0:(L<0?0:(L>=100?K-B:K*L/J-A))")
  field(FLNK, "Cryo-HeVol:MagIns:VolGHe-2")
}

record (calc, "Cryo-HeVol:MagIns:VolGHe-2") {
  field(DESC, "GHe volume above lambda plate")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:MagIns:Vol-2")
  field(INPB, "Cryo-HeVol:MagIns:VolLHe-2")
  field(INPC, "Cryo-HeVol:Foam-3:Volume")
  field(CALC, "A-C-B")
}

# He mass below the lambda plate

record (calc, "Cryo-HeVol:MagIns:MassLHe-1") {
  field(EGU, "kg")
  field(PREC, 1)
  field(SCAN, "10 second")
  field(PHAS, "1")
  field(INPA, "-5.02")
  field(INPB, "21.5")
  field(INPC, "125")
  field(INPJ, "CstatV-LHe:TT663M:sRdV.SEVR")
  field(INPK, "CstatV-LHe:TT663M:sRdV")
  field(INPL, "Cryo-HeVol:MagIns:VolLHe-1")
  field(CALC, "((K>5)||(J>2))?0:(A*K*K+B*K+C)*L")
  field(FLNK, "Cryo-HeVol:MagIns:MassGHe-1")
}

record (calc, "Cryo-HeVol:MagIns:MassGHe-1") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "58")
  field(INPB, "1013")
  field(INPH, "CstatV-LHe:PT680:sRdV.SEVR")
  field(INPI, "CstatV-LHe:TT667M:sRdV.SEVR")
  field(INPJ, "CstatV-LHe:PT680:sRdV")
  field(INPK, "CstatV-LHe:TT667M:sRdV")
  field(INPL, "Cryo-HeVol:MagIns:VolGHe-1")
  field(CALC, "((H>2)||(I>2))?0:(A/K*J/B)*L")
  field(FLNK, "Cryo-HeVol:MagIns:MassHe-1")
}

record (calc, "Cryo-HeVol:MagIns:MassHe-1") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:MagIns:MassLHe-1")
  field(INPB, "Cryo-HeVol:MagIns:MassGHe-1")
  field(CALC, "A+B")
}

# He mass above the lambda plate

record (calc, "Cryo-HeVol:MagIns:MassLHe-2") {
  field(EGU, "kg")
  field(PREC, 1)
  field(SCAN, "10 second")
  field(PHAS, "1")
  field(INPA, "-5.02")
  field(INPB, "21.5")
  field(INPC, "125")
  field(INPJ, "CstatV-LHe:TT668M:sRdV.SEVR")
  field(INPK, "CstatV-LHe:TT668M:sRdV")
  field(INPL, "Cryo-HeVol:MagIns:VolLHe-2")
  field(CALC, "((K>5)||(J>2))?0:(A*K*K+B*K+C)*L")
  field(FLNK, "Cryo-HeVol:MagIns:MassGHe-2")
}

record (calc, "Cryo-HeVol:MagIns:MassGHe-2") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "58")
  field(INPB, "1013")
  field(INPG, "CstatV-LHe:PT680:sRdV.SEVR")
  field(INPH, "CstatV-LHe:TT669M:sRdV.SEVR")
  field(INPI, "Cryo-HeVol:MagIns:VolGHe-4")
  field(INPJ, "CstatV-LHe:PT680:sRdV")
  field(INPK, "CstatV-LHe:TT669M:sRdV")
  field(INPL, "Cryo-HeVol:MagIns:VolGHe-2")
  field(CALC, "((G>2)||(H>2))?0:(A/K*J/B)*(I+L)")
  field(FLNK, "Cryo-HeVol:MagIns:MassHe-2")
}

record (calc, "Cryo-HeVol:MagIns:MassHe-2") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:MagIns:MassLHe-2")
  field(INPB, "Cryo-HeVol:MagIns:MassGHe-2")
  field(CALC, "A+B")
}


# Dewars
##################

record (calc, "Cryo-CBox:LP:PI3290:sRdV") {
  field(EGU, "mbar")
  field(PREC, 1)
  field(SCAN, "10 second")
  field(INPA, "Cryo-CBox:LP:PI3290")
  field(INPB, "1000")
  field(CALC, "A*B")
}


# Help records
##################

record (ai, "Env-Container:TT001-smooth:sRdV") {
    field(DESC, "Very smoothed T for HeVol")
    field(SCAN, "5 second")
    field(EGU, "ᵒC")
    field(PREC, 1)
    field(INP, "Env-Container:TT001:sRdV")
    field(SMOO, "0.9995")
    field(DTYP, "Soft Channel")
}

record (bo, "Cryo-HeVol:Ctrl:Reset") {
  field(DESC, "Reset the He balance accounting")
  field(HIGH, "0.5")
  field(UDFS, NO_ALARM)
  field(FLNK, "Cryo-HeVol:Ctrl:Fanout")
}

record (fanout, "Cryo-HeVol:Ctrl:Fanout") {
  field(LNK1, "Cryo-HeVol:D24:InOut-Rst")
  field(LNK2, "Cryo-HeVol:D356:InOut-Rst")
  field(LNK3, "Cryo-HeVol:D357:InOut-Rst")
  field(LNK4, "Cryo-HeVol:D841:InOut-Rst")
  field(LNK5, "Cryo-HeVol:D590:InOut-Rst")
  field(LNK6, "Cryo-HeVol:HPstorage:InOut-Rst")
  field(LNKD, "Cryo-HeVol:Ctrl:ResetTime")
  field(LNKE, "Cryo-HeVol:Ctrl:GHeRet-Save")
  field(LNKF, "Cryo-HeVol:Ctrl:Total:MassHe-Save")
}

record (calc, "Cryo-HeVol:Ctrl:Zero") {
  field(CALC, "0")
  field(PINI, YES)
}

record (ao, "Cryo-HeVol:Total-0:MassHe") {
  field(DESC, "Total mass of helium at Reset")
  field(EGU, "kg")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(DOL, "Cryo-HeVol:Total:MassHe")
}

record (calcout, "Cryo-HeVol:Ctrl:Total:MassHe-Save") {
  field(INPA, "Cryo-HeVol:Ctrl:Reset")
  field(CALC, "A=1?1:0")
  field(OUT, "Cryo-HeVol:Total-0:MassHe.OMSL")
  field(FLNK, "Cryo-HeVol:Total-0:MassHe.PROC")
}


record (stringin, "Cryo-HeVol:Ctrl:ResetTime") {
  field(DTYP, "Soft Timestamp")
  field(PINI, NO)
  info(autosaveFields,"VAL")
  field(UDFS, NO_ALARM)
  field(INP, "@%Y-%m-%d %H:%M:%S")
}

# Gas helium return
###################
record (longout, "Cryo-HeVol:GHeRet-0:Counter") {
  field(DESC, "Return GHe Counter at Reset")
  field(EGU, "")
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(DOL, "Cryo-HeVol:ReturnCnt")
}

record (calcout, "Cryo-HeVol:Ctrl:GHeRet-Save") {
  field(INPA, "Cryo-HeVol:Ctrl:Reset")
  field(CALC, "A=1?1:0")
  field(OUT, "Cryo-HeVol:GHeRet-0:Counter.OMSL")
  field(FLNK, "Cryo-HeVol:GHeRet-0:Counter.PROC")
}

record (calc, "Cryo-HeVol:GHeRet:dMassHe") {
  field(DESC, "GHe return")
  field(EGU, "kg")
  field(PREC, "1")
#  field(PINI, YES)
  field(INPA, "0.163")
  field(INPB, "0.1")
  field(INPI, "Cryo-HeVol:ReturnCnt")
  field(INPJ, "Cryo-HeVol:GHeRet-0:Counter")
  field(CALC, "(I-J)*A*B")
}
record (ao, "Cryo-HeVol:Foam-1:BottomPos") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-1:BottomPosPerCnt")
}
record (calc, "Cryo-HeVol:Foam-1:BottomPosPerCnt") {
  field(EGU, "%")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Foam-1:BottomPos")
  field(INPB, "260")
  field(CALC, "100*A/B")
}

record (ao, "Cryo-HeVol:Foam-1:Height") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-1:HeightPerCnt")
}
record (calc, "Cryo-HeVol:Foam-1:HeightPerCnt") {
  field(EGU, "%")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Foam-1:Height")
  field(INPB, "260")
  field(CALC, "100*A/B")
  field(FLNK, "Cryo-HeVol:Foam-1:Volume")
}

record (ao, "Cryo-HeVol:Foam-1:InnerDiam") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-1:Volume")
}
record (ao, "Cryo-HeVol:Foam-1:OuterDiam") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-1:Volume")
}

record (calc, "Cryo-HeVol:Foam-1:Volume") {
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:Foam-1:Height")
  field(INPB, "Cryo-HeVol:Foam-1:InnerDiam")
  field(INPC, "Cryo-HeVol:Foam-1:OuterDiam")
  field(INPL, "3.1415926")
  field(CALC, "(C-B)*(C-B)*A*L/4000000")
}

# INPA - total volume [m³]
# INPB - Bottom pos [%] of LI680
# INPC - Height in [%] of LI680

record(calc, "Cryo-HeVol:Foam-1:VolGas") {
  field(EGU, "m³")
  field(PREC, 3)
  field(SCAN, "2 second")
  field(INPA, "Cryo-HeVol:Foam-1:Volume")
  field(INPB, "Cryo-HeVol:Foam-1:BottomPosPerCnt")
  field(INPC, "Cryo-HeVol:Foam-1:HeightPerCnt")
  field(INPK, "CstatV-LHe:LI680:sRdV")
  field(CALC, "K<B?A:(K>=(B+C)?0:A*(B+C-K)/C)")
  field(FLNK, "Cryo-HeVol:Foam-1:VolLHe")
}

record(calc, "Cryo-HeVol:Foam-1:VolLHe") {
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:Foam-1:Volume")
  field(INPB, "Cryo-HeVol:Foam-1:VolGas")
  field(CALC, "A-B")
}
record (ao, "Cryo-HeVol:Foam-2:BottomPos") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-2:BottomPosPerCnt")
}
record (calc, "Cryo-HeVol:Foam-2:BottomPosPerCnt") {
  field(EGU, "%")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Foam-2:BottomPos")
  field(INPB, "260")
  field(CALC, "100*A/B")
}

record (ao, "Cryo-HeVol:Foam-2:Height") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-2:HeightPerCnt")
}
record (calc, "Cryo-HeVol:Foam-2:HeightPerCnt") {
  field(EGU, "%")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Foam-2:Height")
  field(INPB, "260")
  field(CALC, "100*A/B")
  field(FLNK, "Cryo-HeVol:Foam-2:Volume")
}

record (ao, "Cryo-HeVol:Foam-2:InnerDiam") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-2:Volume")
}
record (ao, "Cryo-HeVol:Foam-2:OuterDiam") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-2:Volume")
}

record (calc, "Cryo-HeVol:Foam-2:Volume") {
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:Foam-2:Height")
  field(INPB, "Cryo-HeVol:Foam-2:InnerDiam")
  field(INPC, "Cryo-HeVol:Foam-2:OuterDiam")
  field(INPL, "3.1415926")
  field(CALC, "(C-B)*(C-B)*A*L/4000000")
}

# INPA - total volume [m³]
# INPB - Bottom pos [%] of LI680
# INPC - Height in [%] of LI680

record(calc, "Cryo-HeVol:Foam-2:VolGas") {
  field(EGU, "m³")
  field(PREC, 3)
  field(SCAN, "2 second")
  field(INPA, "Cryo-HeVol:Foam-2:Volume")
  field(INPB, "Cryo-HeVol:Foam-2:BottomPosPerCnt")
  field(INPC, "Cryo-HeVol:Foam-2:HeightPerCnt")
  field(INPK, "CstatV-LHe:LI680:sRdV")
  field(CALC, "K<B?A:(K>=(B+C)?0:A*(B+C-K)/C)")
  field(FLNK, "Cryo-HeVol:Foam-2:VolLHe")
}

record(calc, "Cryo-HeVol:Foam-2:VolLHe") {
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:Foam-2:Volume")
  field(INPB, "Cryo-HeVol:Foam-2:VolGas")
  field(CALC, "A-B")
}
record (ao, "Cryo-HeVol:Magnet:BottomPos") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Magnet:BottomPosPerCnt")
}
record (calc, "Cryo-HeVol:Magnet:BottomPosPerCnt") {
  field(EGU, "%")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Magnet:BottomPos")
  field(INPB, "260")
  field(CALC, "100*A/B")
}

record (ao, "Cryo-HeVol:Magnet:Height") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Magnet:HeightPerCnt")
}
record (calc, "Cryo-HeVol:Magnet:HeightPerCnt") {
  field(EGU, "%")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Magnet:Height")
  field(INPB, "260")
  field(CALC, "100*A/B")
  field(FLNK, "Cryo-HeVol:Magnet:Volume")
}

record (ao, "Cryo-HeVol:Magnet:InnerDiam") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Magnet:Volume")
}
record (ao, "Cryo-HeVol:Magnet:OuterDiam") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Magnet:Volume")
}

record (calc, "Cryo-HeVol:Magnet:Volume") {
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:Magnet:Height")
  field(INPB, "Cryo-HeVol:Magnet:InnerDiam")
  field(INPC, "Cryo-HeVol:Magnet:OuterDiam")
  field(INPL, "3.1415926")
  field(CALC, "(C-B)*(C-B)*A*L/4000000")
}

# INPA - total volume [m³]
# INPB - Bottom pos [%] of LI680
# INPC - Height in [%] of LI680

record(calc, "Cryo-HeVol:Magnet:VolGas") {
  field(EGU, "m³")
  field(PREC, 3)
  field(SCAN, "2 second")
  field(INPA, "Cryo-HeVol:Magnet:Volume")
  field(INPB, "Cryo-HeVol:Magnet:BottomPosPerCnt")
  field(INPC, "Cryo-HeVol:Magnet:HeightPerCnt")
  field(INPK, "CstatV-LHe:LI680:sRdV")
  field(CALC, "K<B?A:(K>=(B+C)?0:A*(B+C-K)/C)")
  field(FLNK, "Cryo-HeVol:Magnet:VolLHe")
}

record(calc, "Cryo-HeVol:Magnet:VolLHe") {
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:Magnet:Volume")
  field(INPB, "Cryo-HeVol:Magnet:VolGas")
  field(CALC, "A-B")
}
record (ao, "Cryo-HeVol:Foam-3:BottomPos") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-3:BottomPosPerCnt")
}
record (calc, "Cryo-HeVol:Foam-3:BottomPosPerCnt") {
  field(EGU, "%")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Foam-3:BottomPos")
  field(INPB, "57.5")
  field(CALC, "100*A/B")
}

record (ao, "Cryo-HeVol:Foam-3:Height") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-3:HeightPerCnt")
}
record (calc, "Cryo-HeVol:Foam-3:HeightPerCnt") {
  field(EGU, "%")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Foam-3:Height")
  field(INPB, "57.5")
  field(CALC, "100*A/B")
  field(FLNK, "Cryo-HeVol:Foam-3:Volume")
}

record (ao, "Cryo-HeVol:Foam-3:InnerDiam") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-3:Volume")
}
record (ao, "Cryo-HeVol:Foam-3:OuterDiam") {
  field(EGU, "cm")
  field(PREC, 1)
  field(PINI, YES)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Foam-3:Volume")
}

record (calc, "Cryo-HeVol:Foam-3:Volume") {
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:Foam-3:Height")
  field(INPB, "Cryo-HeVol:Foam-3:InnerDiam")
  field(INPC, "Cryo-HeVol:Foam-3:OuterDiam")
  field(INPL, "3.1415926")
  field(CALC, "(C-B)*(C-B)*A*L/4000000")
}

# INPA - total volume [m³]
# INPB - Bottom pos [%] of LT682
# INPC - Height in [%] of LT682

record(calc, "Cryo-HeVol:Foam-3:VolGas") {
  field(EGU, "m³")
  field(PREC, 3)
  field(SCAN, "2 second")
  field(INPA, "Cryo-HeVol:Foam-3:Volume")
  field(INPB, "Cryo-HeVol:Foam-3:BottomPosPerCnt")
  field(INPC, "Cryo-HeVol:Foam-3:HeightPerCnt")
  field(INPK, "CstatV-LHe:LT682:sRdV")
  field(CALC, "K<B?A:(K>=(B+C)?0:A*(B+C-K)/C)")
  field(FLNK, "Cryo-HeVol:Foam-3:VolLHe")
}

record(calc, "Cryo-HeVol:Foam-3:VolLHe") {
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:Foam-3:Volume")
  field(INPB, "Cryo-HeVol:Foam-3:VolGas")
  field(CALC, "A-B")
}
record (ao, "Cryo-HeVol:MagIns:Vol-3") {
  field(DESC, "Volume of the HX683")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "0.004")
  field(PINI, "YES")
}
record (calc, "Cryo-HeVol:MagIns:VolLHe-3") {
  field(DESC, "LHe volume in HX683")
  field(SCAN, "10 second")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPG, "CstatV-Ctrl:MagIns:sInp")
  field(INPJ, "100")
  field(INPK, "Cryo-HeVol:MagIns:Vol-3")
  field(INPL, "CstatV-LHe:LT683:sRdV")
  field(CALC, "G#1?0:(L<0?0:(L>=J?K:K*L/J))")
  field(FLNK, "Cryo-HeVol:MagIns:VolGHe-3")
}

record (calc, "Cryo-HeVol:MagIns:VolGHe-3") {
  field(DESC, "GHe volume in HX683")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:MagIns:Vol-3")
  field(INPB, "Cryo-HeVol:MagIns:VolLHe-3")
  field(CALC, "A-B")
  field(FLNK, "Cryo-HeVol:MagIns:MassLHe-3")
}

record (calc, "Cryo-HeVol:MagIns:MassLHe-3") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "-1.1766")
  field(INPB, "6.1229")
  field(INPC, "-11.763")
  field(INPD, "153.73")
  field(INPK, "CstatV-LHe:TT668M:sRdV")
  field(INPL, "Cryo-HeVol:MagIns:VolLHe-3")
  field(CALC, "K<5?(K<1.8?0:(A*(K^3)+B*(K^2)+C*K+D)*L):0")
  field(FLNK, "Cryo-HeVol:MagIns:MassGHe-3")
}

record (calc, "Cryo-HeVol:MagIns:MassGHe-3") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "58")
  field(INPB, "1013")
  field(INPJ, "CstatV-LHe:PT660M:sRdV")
  field(INPK, "CstatV-LHe:TT685:sRdV")
  field(INPL, "Cryo-HeVol:MagIns:VolGHe-3")
  field(CALC, "((K>4)&&(K<320))?(J<3000?(A/K*J/B)*L:(A/K)*L):0")
  field(FLNK, "Cryo-HeVol:MagIns:MassHe-3")
}

record (calc, "Cryo-HeVol:MagIns:MassHe-3") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:MagIns:MassLHe-3")
  field(INPB, "Cryo-HeVol:MagIns:MassGHe-3")
  field(CALC, "A+B")
}


record (ao, "Cryo-HeVol:CstatV-VBox:Vol") {
  field(DESC, "Volume of the Gersemi's valve box")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "0.071")
  field(PINI, "YES")
}
record (calc, "Cryo-HeVol:CstatV-VBox:VolLHe") {
  field(DESC, "LHe volume in Gersemi's valve box")
  field(SCAN, "10 second")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPG, "0")
  field(INPJ, "100")
  field(INPK, "Cryo-HeVol:CstatV-VBox:Vol")
  field(INPL, "CstatV-LHe:LT600:sRdV")
  field(CALC, "L<0?0:(L>=J?K:K*L/J)")
  field(FLNK, "Cryo-HeVol:CstatV-VBox:VolGHe")
}

record (calc, "Cryo-HeVol:CstatV-VBox:VolGHe") {
  field(DESC, "GHe volume in Gersemi's valve box")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:CstatV-VBox:Vol")
  field(INPB, "Cryo-HeVol:CstatV-VBox:VolLHe")
  field(CALC, "A-B")
  field(FLNK, "Cryo-HeVol:CstatV-VBox:MassLHe")
}

record (calc, "Cryo-HeVol:CstatV-VBox:MassLHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "-1.1766")
  field(INPB, "6.1229")
  field(INPC, "-11.763")
  field(INPD, "153.73")
  field(INPK, "CstatV-LHe:TT613:sRdV")
  field(INPL, "Cryo-HeVol:CstatV-VBox:VolLHe")
  field(CALC, "K<5?(K<1.8?0:(A*(K^3)+B*(K^2)+C*K+D)*L):0")
  field(FLNK, "Cryo-HeVol:CstatV-VBox:MassGHe")
}

record (calc, "Cryo-HeVol:CstatV-VBox:MassGHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "58")
  field(INPB, "1013")
  field(INPJ, "CstatV-LHe:PT600:sRdV")
  field(INPK, "CstatV-LHe:TT603:sRdV")
  field(INPL, "Cryo-HeVol:CstatV-VBox:VolGHe")
  field(CALC, "((K>4)&&(K<320))?(J<3000?(A/K*J/B)*L:(A/K)*L):0")
  field(FLNK, "Cryo-HeVol:CstatV-VBox:MassHe")
}

record (calc, "Cryo-HeVol:CstatV-VBox:MassHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:CstatV-VBox:MassLHe")
  field(INPB, "Cryo-HeVol:CstatV-VBox:MassGHe")
  field(CALC, "A+B")
}


record (ao, "Cryo-HeVol:CM-VBox:Vol") {
  field(DESC, "Volume of the CM's valve box")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "0.015")
  field(PINI, "YES")
}
record (calc, "Cryo-HeVol:CM-VBox:VolLHe") {
  field(DESC, "LHe volume in CM's valve box")
  field(SCAN, "10 second")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPG, "0")
  field(INPJ, "74")
  field(INPK, "Cryo-HeVol:CM-VBox:Vol")
  field(INPL, "CM-VBox:LT03:sRdV")
  field(CALC, "L<0?0:(L>=J?K:K*L/J)")
  field(FLNK, "Cryo-HeVol:CM-VBox:VolGHe")
}

record (calc, "Cryo-HeVol:CM-VBox:VolGHe") {
  field(DESC, "GHe volume in CM's valve box")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:CM-VBox:Vol")
  field(INPB, "Cryo-HeVol:CM-VBox:VolLHe")
  field(CALC, "A-B")
  field(FLNK, "Cryo-HeVol:CM-VBox:MassLHe")
}

record (calc, "Cryo-HeVol:CM-VBox:MassLHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "-1.1766")
  field(INPB, "6.1229")
  field(INPC, "-11.763")
  field(INPD, "153.73")
  field(INPK, "4.5")
  field(INPL, "Cryo-HeVol:CM-VBox:VolLHe")
  field(CALC, "K<5?(K<1.8?0:(A*(K^3)+B*(K^2)+C*K+D)*L):0")
  field(FLNK, "Cryo-HeVol:CM-VBox:MassGHe")
}

record (calc, "Cryo-HeVol:CM-VBox:MassGHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "58")
  field(INPB, "1013")
  field(INPJ, "CstatH-RHtr:PT550:sRdV")
  field(INPK, "CM-VBox:TT01:sRdV")
  field(INPL, "Cryo-HeVol:CM-VBox:VolGHe")
  field(CALC, "((K>4)&&(K<320))?(J<3000?(A/K*J/B)*L:(A/K)*L):0")
  field(FLNK, "Cryo-HeVol:CM-VBox:MassHe")
}

record (calc, "Cryo-HeVol:CM-VBox:MassHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:CM-VBox:MassLHe")
  field(INPB, "Cryo-HeVol:CM-VBox:MassGHe")
  field(CALC, "A+B")
}


record (ao, "Cryo-HeVol:CM-CM:Vol") {
  field(DESC, "Volume of the Cryomodule")
  field(EGU, "m³")
  field(PREC, 3)
  field(VAL, "0.122")
  field(PINI, "YES")
}
record (calc, "Cryo-HeVol:CM-CM:VolLHe") {
  field(DESC, "LHe volume in Cryomodule")
  field(SCAN, "10 second")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPG, "0")
  field(INPJ, "68")
  field(INPK, "Cryo-HeVol:CM-CM:Vol")
  field(INPL, "CM-CM:LT01:sRdV")
  field(CALC, "L<0?0:(L>=J?K:(L<52?2.23e-3*L:(L-52)*3.75e-4+0.116))")
  field(FLNK, "Cryo-HeVol:CM-CM:VolGHe")
}

record (calc, "Cryo-HeVol:CM-CM:VolGHe") {
  field(DESC, "GHe volume in Cryomodule")
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:CM-CM:Vol")
  field(INPB, "Cryo-HeVol:CM-CM:VolLHe")
  field(CALC, "A-B")
  field(FLNK, "Cryo-HeVol:CM-CM:MassLHe")
}

record (calc, "Cryo-HeVol:CM-CM:MassLHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "-1.1766")
  field(INPB, "6.1229")
  field(INPC, "-11.763")
  field(INPD, "153.73")
  field(INPK, "CM-CM:TT04:sRdV")
  field(INPL, "Cryo-HeVol:CM-CM:VolLHe")
  field(CALC, "K<5?(K<1.8?0:(A*(K^3)+B*(K^2)+C*K+D)*L):0")
  field(FLNK, "Cryo-HeVol:CM-CM:MassGHe")
}

record (calc, "Cryo-HeVol:CM-CM:MassGHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "58")
  field(INPB, "1013")
  field(INPJ, "CM-CM:PT02-direct:sRdV")
  field(INPK, "CM-CM:TT09:sRdV")
  field(INPL, "Cryo-HeVol:CM-CM:VolGHe")
  field(CALC, "((K>4)&&(K<320))?(J<3000?(A/K*J/B)*L:(A/K)*L):0")
  field(FLNK, "Cryo-HeVol:CM-CM:MassHe")
}

record (calc, "Cryo-HeVol:CM-CM:MassHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:CM-CM:MassLHe")
  field(INPB, "Cryo-HeVol:CM-CM:MassGHe")
  field(CALC, "A+B")
}


# CstatV - magnet insert
#########################

  record (calc, "Cryo-HeVol:CstatV:VolLHe") {
  field(EGU, "m³")
  field(PREC, 3)
  field(SCAN, "10 second")
  field(PHAS, "2")
  field(INPA, "Cryo-HeVol:MagIns:VolLHe-1")
  field(INPB, "Cryo-HeVol:MagIns:VolLHe-2")
  field(INPC, "Cryo-HeVol:MagIns:VolLHe-3")
  field(INPD, "Cryo-HeVol:CstatV-VBox:VolLHe")
  field(CALC, "A+B+C+D")
  field(FLNK, "Cryo-HeVol:CstatV:VolGHe")
}
record (calc, "Cryo-HeVol:CstatV:VolGHe") {
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:MagIns:VolGHe-1")
  field(INPB, "Cryo-HeVol:MagIns:VolGHe-2")
  field(INPC, "Cryo-HeVol:MagIns:VolGHe-3")
  field(INPD, "Cryo-HeVol:CstatV-VBox:VolGHe")
  field(CALC, "A+B+C+D")
  field(FLNK, "Cryo-HeVol:CstatV:MassLHe")
}

record (calc, "Cryo-HeVol:CstatV:MassLHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:MagIns:MassLHe-1")
  field(INPB, "Cryo-HeVol:MagIns:MassLHe-2")
  field(INPC, "Cryo-HeVol:MagIns:MassLHe-3")
  field(INPD, "Cryo-HeVol:CstatV-VBox:MassLHe")
  field(CALC, "A+B+C+D")
  field(FLNK, "Cryo-HeVol:CstatV:MassGHe")
}
record (calc, "Cryo-HeVol:CstatV:MassGHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:MagIns:MassGHe-1")
  field(INPB, "Cryo-HeVol:MagIns:MassGHe-2")
  field(INPC, "Cryo-HeVol:MagIns:MassGHe-3")
  field(INPD, "Cryo-HeVol:CstatV-VBox:MassGHe")
  field(CALC, "A+B+C+D")
  field(FLNK, "Cryo-HeVol:CstatV:MassHe")
}
record (calc, "Cryo-HeVol:CstatV:MassHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:CstatV:MassLHe")
  field(INPB, "Cryo-HeVol:CstatV:MassGHe")
  field(CALC, "A+B")
}

# Cryomodule  
########################################

record (calc, "Cryo-HeVol:CM:VolLHe") {
  field(EGU, "m³")
  field(PREC, 3)
  field(SCAN, "10 second")
  field(PHAS, "1")
  field(INPA, "Cryo-HeVol:CM-VBox:VolLHe")
  field(INPB, "Cryo-HeVol:CM-CM:VolLHe")
  field(CALC, "A+B")
  field(FLNK, "Cryo-HeVol:CM:VolGHe")
}
record (calc, "Cryo-HeVol:CM:VolGHe") {
  field(EGU, "m³")
  field(PREC, 3)
  field(INPA, "Cryo-HeVol:CM-VBox:VolGHe")
  field(INPB, "Cryo-HeVol:CM-CM:VolGHe")
  field(CALC, "A+B")
  field(FLNK, "Cryo-HeVol:CM:MassLHe")
}

record (calc, "Cryo-HeVol:CM:MassLHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:CM-VBox:MassLHe")
  field(INPB, "Cryo-HeVol:CM-CM:MassLHe")
  field(CALC, "A+B")
  field(FLNK, "Cryo-HeVol:CM:MassGHe")
}
record (calc, "Cryo-HeVol:CM:MassGHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:CM-VBox:MassGHe")
  field(INPB, "Cryo-HeVol:CM-CM:MassGHe")
  field(CALC, "A+B")
  field(FLNK, "Cryo-HeVol:CM:MassHe")
}
record (calc, "Cryo-HeVol:CM:MassHe") {
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:CM:MassLHe")
  field(INPB, "Cryo-HeVol:CM:MassGHe")
  field(CALC, "A+B")
}

#######################################
# TOTALS
######################################

record (fanout, "Cryo-HeVol:Ctrl:Totals-fanout") {
  field(SCAN, "10 second")
  field(PHAS, 3)
  field(LNK0, "Cryo-HeVol:GHeRet:dMassHe")
  field(LNK1, "Cryo-HeVol:Total:MassGHe-calc")
  field(LNK2, "Cryo-HeVol:Total:MassLHe-calc")
  field(LNK3, "Cryo-HeVol:Total:MassHe-calc")
  field(LNK4, "Cryo-HeVol:Losses:dMassHe")
#  field(LNK5, 
}

record (calcout, "Cryo-HeVol:Total:MassGHe-calc") {
  field(DESC, "Total mass of helium in gas phase")
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:BufTank:MassGHe")
  field(INPB, "Cryo-HeVol:HPstorage:MassGHe")
  field(INPC, "Cryo-HeVol:GasBag:MassGHe")
  field(INPD, "Cryo-HeVol:Dwr:MassGHe")
  field(INPE, "Cryo-HeVol:CstatV:MassGHe")
  field(INPF, "Cryo-HeVol:CM:MassGHe")
  field(INPG, "Cryo-HeVol:D24:MassGHe")
  field(INPH, "Cryo-HeVol:D356:MassGHe")
  field(INPI, "Cryo-HeVol:D357:MassGHe")
  field(INPJ, "Cryo-HeVol:D841:MassGHe")
  field(INPK, "Cryo-HeVol:D590:MassGHe")
  field(CALC, "A+B+C+D+E+F+G+H+I+J+K")
  field(OUT, "Cryo-HeVol:Total:MassGHe PP")
}

record (ao, "Cryo-HeVol:Total:MassGHe") {
  field(DESC, "Total mass of helium in gas phase")
  field(PINI, YES)
  field(EGU, "kg")
  field(PREC, 1)
  info(autosaveFields,"VAL")
}

record (calcout, "Cryo-HeVol:Total:MassLHe-calc") {
  field(DESC, "Total mass of helium in liquid phase")
  field(EGU, "kg")
  field(PREC, 1)
  field(INPD, "Cryo-HeVol:Dwr:MassLHe")
  field(INPE, "Cryo-HeVol:CstatV:MassLHe")
  field(INPF, "Cryo-HeVol:CM:MassLHe")
  field(INPG, "Cryo-HeVol:D24:MassLHe")
  field(INPH, "Cryo-HeVol:D356:MassLHe")
  field(INPI, "Cryo-HeVol:D357:MassLHe")
  field(INPJ, "Cryo-HeVol:D841:MassLHe")
  field(INPK, "Cryo-HeVol:D590:MassLHe")
  field(CALC, "D+E+F+G+H+I+J+K")
  field(OUT, "Cryo-HeVol:Total:MassLHe PP")
}

record (ao, "Cryo-HeVol:Total:MassLHe") {
  field(DESC, "Total mass of helium in liquid phase")
  field(PINI, YES)
  field(EGU, "kg")
  field(PREC, 1)
  info(autosaveFields,"VAL")
}

record (calcout, "Cryo-HeVol:Total:MassHe-calc") {
  field(DESC, "Total mass of helium in the system")
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Total:MassLHe")
  field(INPB, "Cryo-HeVol:Total:MassGHe")
  field(CALC, "A+B")
  field(OUT, "Cryo-HeVol:Total:MassHe PP")
  field(FLNK, "Cryo-HeVol:CryoPlant:MassHe.PROC")
}

record (ao, "Cryo-HeVol:Total:MassHe") {
  field(DESC, "Total mass of helium in the system")
  field(PINI, YES)
  field(EGU, "kg")
  field(PREC, 1)
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:Total:VolHeEquiv")
}


record (calc, "Cryo-HeVol:CryoPlant:MassHe") {
  field(DESC, "Total mass of helium in the cryo plant")
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Dwr:MassHe")
  field(INPB, "Cryo-HeVol:HPstorage:MassGHe")
  field(INPC, "Cryo-HeVol:BufTank:MassGHe")
  field(INPD, "Cryo-HeVol:GasBag:MassGHe")
  field(INPE, "Cryo-HeVol:D24:MassHe")
  field(INPF, "Cryo-HeVol:D356:MassHe")
  field(INPG, "Cryo-HeVol:D357:MassHe")
  field(INPH, "Cryo-HeVol:D841:MassHe")
  field(INPI, "Cryo-HeVol:D590:MassHe")
  field(CALC, "A+B+C+D+E+F+G+H+I")
}

record (calc, "Cryo-HeVol:Total:VolHeEquiv") {
  field(DESC, "Total mass as volume at 1 atm and 300K")
  field(EGU, "m³")
  field(PREC, 0)
  field(INPA, "0.163")
  field(INPB, "Cryo-HeVol:Total:MassHe")
  field(CALC, "B/A")
}

record (calc, "Cryo-HeVol:Losses:dMassHe") {
  field(DESC, "He losses")
  field(EGU, "kg")
  field(PREC, 1)
  field(INPA, "Cryo-HeVol:Total-0:MassHe")
  field(INPB, "Cryo-HeVol:Total:MassHe")
  field(INPC, "Cryo-HeVol:GHeRet:dMassHe")
  field(INPD, "Cryo-HeVol:D24:dMassHe")
  field(INPE, "Cryo-HeVol:D356:dMassHe")
  field(INPF, "Cryo-HeVol:D357:dMassHe")
  field(INPG, "Cryo-HeVol:D841:dMassHe")
  field(INPH, "Cryo-HeVol:D590:dMassHe")
  field(INPI, "Cryo-HeVol:HPstorage:dMassHe")
  field(CALC, "A-B+C+D+E+F+G+H+I")
}
record (ao, "Cryo-HeVol:Dwr:Vol") {
  field(DESC, "Volume of Linde dewar")
  field(EGU, "m³")
  field(PREC, "3")
  field(VAL, "2.0")
  field(PINI, "YES")
}

record (calc, "Cryo-HeVol:Dwr:VolLHe") {
  field(SCAN, "10 second")
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-Dwr:LHe:LI5200_Lt")
  field(CALC, "A/1000")
  field(FLNK, "Cryo-HeVol:Dwr:VolGHe")
}

record (calc, "Cryo-HeVol:Dwr:VolGHe") {
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-Dwr:LHe:LI5200_Lt")
  field(INPB, "Cryo-HeVol:Dwr:Vol")
  field(CALC, "A<0.1?0:B-A/1000")
  field(FLNK, "Cryo-HeVol:Dwr:MassLHe")
}

record (calc, "Cryo-HeVol:Dwr:MassLHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "-2.1995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPK, "Cryo-CBox:LP:PI3290")
  field(INPL, "Cryo-HeVol:Dwr:VolLHe")
  field(CALC, "(A*(K^2)+B*K+C)*L")
  field(FLNK, "Cryo-HeVol:Dwr:MassGHe")
}

record (calc, "Cryo-HeVol:Dwr:MassGHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "0")
  field(INPB, "0")
  field(INPC, "0")
  field(INPK, "Cryo-HeVol:Dwr:GHe-dens")
  field(INPL, "Cryo-HeVol:Dwr:VolGHe")
  field(CALC, "K*L")
  field(FLNK, "Cryo-HeVol:Dwr:MassHe")
}

record (calc, "Cryo-HeVol:Dwr:MassHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "Cryo-HeVol:Dwr:MassLHe")
  field(INPB, "Cryo-HeVol:Dwr:MassGHe")
  field(CALC, "A+B")
}

record (calc, "Cryo-HeVol:Dwr:TT-calc:sRdV") {
  field(EGU, "K")
  field(PREC, "3")
  field(SCAN, "10 second")
  field(INPA, "-0.3193")
  field(INPB, "1.715")
  field(INPC, "2.8012")
  field(INPK, "Cryo-CBox:LP:PI3290")
  field(CALC, "A*(K^2)+B*K+C")
}

record (calc, "Cryo-HeVol:Dwr:GHe-dens") {
  field(EGU, "kg/m³")
  field(PREC, "3")
  field(SCAN, "10 second")
  field(INPA, "0")
  field(INPB, "0")
  field(INPC, "0")
  field(INPK, "Cryo-CBox:LP:PI3290")
  field(INPL, "Cryo-Dwr:LHe:LI5200-PercOut")
  field(CALC, "2.44*K")
}

record (ao, "Cryo-HeVol:D24:VolLHe_Lt") {
  field(DESC, "LHe in D24 dewar [l]")
  field(EGU, "l")
  field(PREC, "1")
  field(PINI, "YES")
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:D24:VolLHe")
}

record (calc, "Cryo-HeVol:D24:TT-calc:sRdV") {
  field(EGU, "K")
  field(PREC, "3")
  field(SCAN, "10 second")
  field(INPA, "-0.3193")
  field(INPB, "1.715")
  field(INPC, "2.8012")
  field(INPK, "1.013")
  field(CALC, "A*(K^2)+B*K+C")
}

record (ao, "Cryo-HeVol:D24:Vol") {
  field(DESC, "Volume of D24 portable dewar")
  field(EGU, "m³")
  field(PREC, "3")
  field(VAL, "0.25")
  field(PINI, "YES")
}

record (calc, "Cryo-HeVol:D24:VolLHe") {
#  field(SCAN, "10 second")
#  field(PHAS, "1")
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-HeVol:D24:VolLHe_Lt")
  field(CALC, "A/1000")
  field(FLNK, "Cryo-HeVol:D24:VolGHe")
}

record (calc, "Cryo-HeVol:D24:VolGHe") {
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-HeVol:D24:VolLHe_Lt")
  field(INPB, "Cryo-HeVol:D24:Vol")
  field(CALC, "A<0.1?0:B-A/1000")
  field(FLNK, "Cryo-HeVol:D24:MassLHe")
}

record (calc, "Cryo-HeVol:D24:MassLHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "-2.19995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPK, "124.4")
  field(INPL, "Cryo-HeVol:D24:VolLHe")
  field(CALC, "K*L")
  field(FLNK, "Cryo-HeVol:D24:MassGHe")
}

# We need to approximate the average density of the He gas in the dewar.
# It depends on the gas temperature distribution in the dewar
# above the LHe. It probably depends on the amount of LHe in the dewar.
# As a first approximation we take assume a constant temperature of the
# gas to be 20 K. The density is then 2.44 kg/m³ at 1013 mbar 

record (calc, "Cryo-HeVol:D24:MassGHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPD, "3.6341")
  field(INPE, "9.9234")
  field(INPF, "2.8838")
  field(INPJ, "Cryo-HeVol:D24:VolLHe")
  field(INPK, "2.44")
  field(INPL, "Cryo-HeVol:D24:VolGHe")
  field(CALC, "J>0?K*L:0")
  field(FLNK, "Cryo-HeVol:D24:MassHe")
}

record (calc, "Cryo-HeVol:D24:MassHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "Cryo-HeVol:D24:MassLHe")
  field(INPB, "Cryo-HeVol:D24:MassGHe")
  field(CALC, "A+B")
}

record (calc, "Cryo-HeVol:D24:LT-calc:sRdV") {
  field(EGU, "%")
  field(PREC, "1")
  field(SCAN, "10 second")
  field(INPA, "Cryo-HeVol:D24:VolLHe_Lt")
  field(INPB, "0.25")
  field(CALC, "0.1*A/B")
}

# PVs for He balance calculations
####################################

record (calcout, "Cryo-HeVol:D24:InOut-Rst") {
  field(INPA, "Cryo-HeVol:Ctrl:Reset")
  field(CALC, "A=1?1:0")
  field(OUT, "Cryo-HeVol:D24:InOut.OMSL")
  field(FLNK, "Cryo-HeVol:D24:InOut.PROC")
}

record (ao, "Cryo-HeVol:D24:InOut") {
  field(DESC, "Adding/removing from the cryo system")
  field(EGU, "l")
  field(DOL, "Cryo-HeVol:Ctrl:Zero")
  field(UDFS, "NO_ALARM")
  field(FLNK, "Cryo-HeVol:D24:dMassHe.PROC")
}

record (calc, "Cryo-HeVol:D24:dMassHe") {
  field(DESC, "LHe delivery(-) and return (+)")
  field(EGU, "kg")
  field(PREC, "1")
  field(PINI, "YES")
  field(INPA, "-2.19995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPD, "3.6341")
  field(INPE, "9.9234")
  field(INPF, "2.8838")
  field(INPG, "0.25")
  field(INPH, "1000.0")
  field(INPI, "Cryo-HeVol:Ctrl:Reset")
  field(INPJ, "Cryo-HeVol:D24:dMassHe")
  field(INPK, "2.44")
  field(INPL, "Cryo-HeVol:D24:InOut")
  field(CALC, "I=1?0:124.4*L/H+(L=0?0:K*(L>0?G-L/H:-L/H-G))+J")
  info(autosaveFields,"VAL")
  field(FLNK,  "Cryo-HeVol:D24:VolLHe_Lt-sel")
}

record(calc, "Cryo-HeVol:D24:VolLHe_Lt-sel") {
  field(INPA, "Cryo-HeVol:D24:InOut")
  field(CALC, "A=0?0:(A>0?1:3)")
  field(FLNK, "Cryo-HeVol:D24:VolLHe_Lt-calc")
}

record (calc, "Cryo-HeVol:D24:VolLHe_Lt-calc") {
  field(INPA, "Cryo-HeVol:D24:InOut")
  field(INPB, "Cryo-HeVol:D24:Vol") 
  field(SDIS, "Cryo-HeVol:D24:InOut-Rst")
#  field(OUT, "Cryo-HeVol:D24:VolLHe_Lt.VAL CA") 
  field(CALC, "MIN(ABS(A),B*1000.0)")
  field(FLNK, "Cryo-HeVol:D24:VolLHe_Lt-seq")
}

record (seq, "Cryo-HeVol:D24:VolLHe_Lt-seq") {
 field(SELM, "Mask")
 field(SELL, "Cryo-HeVol:D24:VolLHe_Lt-sel")
 field(DOL1, "Cryo-HeVol:D24:VolLHe_Lt-calc")
 field(DOL2, "0.0")
 field(LNK1, "Cryo-HeVol:D24:VolLHe_Lt.VAL PP")
 field(DLY1, "0.0")
 field(LNK2, "Cryo-HeVol:D24:VolLHe_Lt.VAL PP")
 field(DLY2, "11.0")
}
record (ao, "Cryo-HeVol:D356:VolLHe_Lt") {
  field(DESC, "LHe in D356 dewar [l]")
  field(EGU, "l")
  field(PREC, "1")
  field(PINI, "YES")
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:D356:VolLHe")
}

record (calc, "Cryo-HeVol:D356:TT-calc:sRdV") {
  field(EGU, "K")
  field(PREC, "3")
  field(SCAN, "10 second")
  field(INPA, "-0.3193")
  field(INPB, "1.715")
  field(INPC, "2.8012")
  field(INPK, "1.013")
  field(CALC, "A*(K^2)+B*K+C")
}

record (ao, "Cryo-HeVol:D356:Vol") {
  field(DESC, "Volume of D356 portable dewar")
  field(EGU, "m³")
  field(PREC, "3")
  field(VAL, "0.1")
  field(PINI, "YES")
}

record (calc, "Cryo-HeVol:D356:VolLHe") {
#  field(SCAN, "10 second")
#  field(PHAS, "1")
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-HeVol:D356:VolLHe_Lt")
  field(CALC, "A/1000")
  field(FLNK, "Cryo-HeVol:D356:VolGHe")
}

record (calc, "Cryo-HeVol:D356:VolGHe") {
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-HeVol:D356:VolLHe_Lt")
  field(INPB, "Cryo-HeVol:D356:Vol")
  field(CALC, "A<0.1?0:B-A/1000")
  field(FLNK, "Cryo-HeVol:D356:MassLHe")
}

record (calc, "Cryo-HeVol:D356:MassLHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "-2.19995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPK, "124.4")
  field(INPL, "Cryo-HeVol:D356:VolLHe")
  field(CALC, "K*L")
  field(FLNK, "Cryo-HeVol:D356:MassGHe")
}

# We need to approximate the average density of the He gas in the dewar.
# It depends on the gas temperature distribution in the dewar
# above the LHe. It probably depends on the amount of LHe in the dewar.
# As a first approximation we take assume a constant temperature of the
# gas to be 20 K. The density is then 2.44 kg/m³ at 1013 mbar 

record (calc, "Cryo-HeVol:D356:MassGHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPD, "3.6341")
  field(INPE, "9.9234")
  field(INPF, "2.8838")
  field(INPJ, "Cryo-HeVol:D356:VolLHe")
  field(INPK, "2.44")
  field(INPL, "Cryo-HeVol:D356:VolGHe")
  field(CALC, "J>0?K*L:0")
  field(FLNK, "Cryo-HeVol:D356:MassHe")
}

record (calc, "Cryo-HeVol:D356:MassHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "Cryo-HeVol:D356:MassLHe")
  field(INPB, "Cryo-HeVol:D356:MassGHe")
  field(CALC, "A+B")
}

record (calc, "Cryo-HeVol:D356:LT-calc:sRdV") {
  field(EGU, "%")
  field(PREC, "1")
  field(SCAN, "10 second")
  field(INPA, "Cryo-HeVol:D356:VolLHe_Lt")
  field(INPB, "0.1")
  field(CALC, "0.1*A/B")
}

# PVs for He balance calculations
####################################

record (calcout, "Cryo-HeVol:D356:InOut-Rst") {
  field(INPA, "Cryo-HeVol:Ctrl:Reset")
  field(CALC, "A=1?1:0")
  field(OUT, "Cryo-HeVol:D356:InOut.OMSL")
  field(FLNK, "Cryo-HeVol:D356:InOut.PROC")
}

record (ao, "Cryo-HeVol:D356:InOut") {
  field(DESC, "Adding/removing from the cryo system")
  field(EGU, "l")
  field(DOL, "Cryo-HeVol:Ctrl:Zero")
  field(UDFS, "NO_ALARM")
  field(FLNK, "Cryo-HeVol:D356:dMassHe.PROC")
}

record (calc, "Cryo-HeVol:D356:dMassHe") {
  field(DESC, "LHe delivery(-) and return (+)")
  field(EGU, "kg")
  field(PREC, "1")
  field(PINI, "YES")
  field(INPA, "-2.19995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPD, "3.6341")
  field(INPE, "9.9234")
  field(INPF, "2.8838")
  field(INPG, "0.1")
  field(INPH, "1000.0")
  field(INPI, "Cryo-HeVol:Ctrl:Reset")
  field(INPJ, "Cryo-HeVol:D356:dMassHe")
  field(INPK, "2.44")
  field(INPL, "Cryo-HeVol:D356:InOut")
  field(CALC, "I=1?0:124.4*L/H+(L=0?0:K*(L>0?G-L/H:-L/H-G))+J")
  info(autosaveFields,"VAL")
  field(FLNK,  "Cryo-HeVol:D356:VolLHe_Lt-sel")
}

record(calc, "Cryo-HeVol:D356:VolLHe_Lt-sel") {
  field(INPA, "Cryo-HeVol:D356:InOut")
  field(CALC, "A=0?0:(A>0?1:3)")
  field(FLNK, "Cryo-HeVol:D356:VolLHe_Lt-calc")
}

record (calc, "Cryo-HeVol:D356:VolLHe_Lt-calc") {
  field(INPA, "Cryo-HeVol:D356:InOut")
  field(INPB, "Cryo-HeVol:D356:Vol") 
  field(SDIS, "Cryo-HeVol:D356:InOut-Rst")
#  field(OUT, "Cryo-HeVol:D356:VolLHe_Lt.VAL CA") 
  field(CALC, "MIN(ABS(A),B*1000.0)")
  field(FLNK, "Cryo-HeVol:D356:VolLHe_Lt-seq")
}

record (seq, "Cryo-HeVol:D356:VolLHe_Lt-seq") {
 field(SELM, "Mask")
 field(SELL, "Cryo-HeVol:D356:VolLHe_Lt-sel")
 field(DOL1, "Cryo-HeVol:D356:VolLHe_Lt-calc")
 field(DOL2, "0.0")
 field(LNK1, "Cryo-HeVol:D356:VolLHe_Lt.VAL PP")
 field(DLY1, "0.0")
 field(LNK2, "Cryo-HeVol:D356:VolLHe_Lt.VAL PP")
 field(DLY2, "11.0")
}
record (ao, "Cryo-HeVol:D357:VolLHe_Lt") {
  field(DESC, "LHe in D357 dewar [l]")
  field(EGU, "l")
  field(PREC, "1")
  field(PINI, "YES")
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:D357:VolLHe")
}

record (calc, "Cryo-HeVol:D357:TT-calc:sRdV") {
  field(EGU, "K")
  field(PREC, "3")
  field(SCAN, "10 second")
  field(INPA, "-0.3193")
  field(INPB, "1.715")
  field(INPC, "2.8012")
  field(INPK, "1.013")
  field(CALC, "A*(K^2)+B*K+C")
}

record (ao, "Cryo-HeVol:D357:Vol") {
  field(DESC, "Volume of D357 portable dewar")
  field(EGU, "m³")
  field(PREC, "3")
  field(VAL, "0.1")
  field(PINI, "YES")
}

record (calc, "Cryo-HeVol:D357:VolLHe") {
#  field(SCAN, "10 second")
#  field(PHAS, "1")
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-HeVol:D357:VolLHe_Lt")
  field(CALC, "A/1000")
  field(FLNK, "Cryo-HeVol:D357:VolGHe")
}

record (calc, "Cryo-HeVol:D357:VolGHe") {
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-HeVol:D357:VolLHe_Lt")
  field(INPB, "Cryo-HeVol:D357:Vol")
  field(CALC, "A<0.1?0:B-A/1000")
  field(FLNK, "Cryo-HeVol:D357:MassLHe")
}

record (calc, "Cryo-HeVol:D357:MassLHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "-2.19995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPK, "124.4")
  field(INPL, "Cryo-HeVol:D357:VolLHe")
  field(CALC, "K*L")
  field(FLNK, "Cryo-HeVol:D357:MassGHe")
}

# We need to approximate the average density of the He gas in the dewar.
# It depends on the gas temperature distribution in the dewar
# above the LHe. It probably depends on the amount of LHe in the dewar.
# As a first approximation we take assume a constant temperature of the
# gas to be 20 K. The density is then 2.44 kg/m³ at 1013 mbar 

record (calc, "Cryo-HeVol:D357:MassGHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPD, "3.6341")
  field(INPE, "9.9234")
  field(INPF, "2.8838")
  field(INPJ, "Cryo-HeVol:D357:VolLHe")
  field(INPK, "2.44")
  field(INPL, "Cryo-HeVol:D357:VolGHe")
  field(CALC, "J>0?K*L:0")
  field(FLNK, "Cryo-HeVol:D357:MassHe")
}

record (calc, "Cryo-HeVol:D357:MassHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "Cryo-HeVol:D357:MassLHe")
  field(INPB, "Cryo-HeVol:D357:MassGHe")
  field(CALC, "A+B")
}

record (calc, "Cryo-HeVol:D357:LT-calc:sRdV") {
  field(EGU, "%")
  field(PREC, "1")
  field(SCAN, "10 second")
  field(INPA, "Cryo-HeVol:D357:VolLHe_Lt")
  field(INPB, "0.1")
  field(CALC, "0.1*A/B")
}

# PVs for He balance calculations
####################################

record (calcout, "Cryo-HeVol:D357:InOut-Rst") {
  field(INPA, "Cryo-HeVol:Ctrl:Reset")
  field(CALC, "A=1?1:0")
  field(OUT, "Cryo-HeVol:D357:InOut.OMSL")
  field(FLNK, "Cryo-HeVol:D357:InOut.PROC")
}

record (ao, "Cryo-HeVol:D357:InOut") {
  field(DESC, "Adding/removing from the cryo system")
  field(EGU, "l")
  field(DOL, "Cryo-HeVol:Ctrl:Zero")
  field(UDFS, "NO_ALARM")
  field(FLNK, "Cryo-HeVol:D357:dMassHe.PROC")
}

record (calc, "Cryo-HeVol:D357:dMassHe") {
  field(DESC, "LHe delivery(-) and return (+)")
  field(EGU, "kg")
  field(PREC, "1")
  field(PINI, "YES")
  field(INPA, "-2.19995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPD, "3.6341")
  field(INPE, "9.9234")
  field(INPF, "2.8838")
  field(INPG, "0.1")
  field(INPH, "1000.0")
  field(INPI, "Cryo-HeVol:Ctrl:Reset")
  field(INPJ, "Cryo-HeVol:D357:dMassHe")
  field(INPK, "2.44")
  field(INPL, "Cryo-HeVol:D357:InOut")
  field(CALC, "I=1?0:124.4*L/H+(L=0?0:K*(L>0?G-L/H:-L/H-G))+J")
  info(autosaveFields,"VAL")
  field(FLNK,  "Cryo-HeVol:D357:VolLHe_Lt-sel")
}

record(calc, "Cryo-HeVol:D357:VolLHe_Lt-sel") {
  field(INPA, "Cryo-HeVol:D357:InOut")
  field(CALC, "A=0?0:(A>0?1:3)")
  field(FLNK, "Cryo-HeVol:D357:VolLHe_Lt-calc")
}

record (calc, "Cryo-HeVol:D357:VolLHe_Lt-calc") {
  field(INPA, "Cryo-HeVol:D357:InOut")
  field(INPB, "Cryo-HeVol:D357:Vol") 
  field(SDIS, "Cryo-HeVol:D357:InOut-Rst")
#  field(OUT, "Cryo-HeVol:D357:VolLHe_Lt.VAL CA") 
  field(CALC, "MIN(ABS(A),B*1000.0)")
  field(FLNK, "Cryo-HeVol:D357:VolLHe_Lt-seq")
}

record (seq, "Cryo-HeVol:D357:VolLHe_Lt-seq") {
 field(SELM, "Mask")
 field(SELL, "Cryo-HeVol:D357:VolLHe_Lt-sel")
 field(DOL1, "Cryo-HeVol:D357:VolLHe_Lt-calc")
 field(DOL2, "0.0")
 field(LNK1, "Cryo-HeVol:D357:VolLHe_Lt.VAL PP")
 field(DLY1, "0.0")
 field(LNK2, "Cryo-HeVol:D357:VolLHe_Lt.VAL PP")
 field(DLY2, "11.0")
}
record (ao, "Cryo-HeVol:D841:VolLHe_Lt") {
  field(DESC, "LHe in D841 dewar [l]")
  field(EGU, "l")
  field(PREC, "1")
  field(PINI, "YES")
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:D841:VolLHe")
}

record (calc, "Cryo-HeVol:D841:TT-calc:sRdV") {
  field(EGU, "K")
  field(PREC, "3")
  field(SCAN, "10 second")
  field(INPA, "-0.3193")
  field(INPB, "1.715")
  field(INPC, "2.8012")
  field(INPK, "1.013")
  field(CALC, "A*(K^2)+B*K+C")
}

record (ao, "Cryo-HeVol:D841:Vol") {
  field(DESC, "Volume of D841 portable dewar")
  field(EGU, "m³")
  field(PREC, "3")
  field(VAL, "0.1")
  field(PINI, "YES")
}

record (calc, "Cryo-HeVol:D841:VolLHe") {
#  field(SCAN, "10 second")
#  field(PHAS, "1")
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-HeVol:D841:VolLHe_Lt")
  field(CALC, "A/1000")
  field(FLNK, "Cryo-HeVol:D841:VolGHe")
}

record (calc, "Cryo-HeVol:D841:VolGHe") {
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-HeVol:D841:VolLHe_Lt")
  field(INPB, "Cryo-HeVol:D841:Vol")
  field(CALC, "A<0.1?0:B-A/1000")
  field(FLNK, "Cryo-HeVol:D841:MassLHe")
}

record (calc, "Cryo-HeVol:D841:MassLHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "-2.19995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPK, "124.4")
  field(INPL, "Cryo-HeVol:D841:VolLHe")
  field(CALC, "K*L")
  field(FLNK, "Cryo-HeVol:D841:MassGHe")
}

# We need to approximate the average density of the He gas in the dewar.
# It depends on the gas temperature distribution in the dewar
# above the LHe. It probably depends on the amount of LHe in the dewar.
# As a first approximation we take assume a constant temperature of the
# gas to be 20 K. The density is then 2.44 kg/m³ at 1013 mbar 

record (calc, "Cryo-HeVol:D841:MassGHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPD, "3.6341")
  field(INPE, "9.9234")
  field(INPF, "2.8838")
  field(INPJ, "Cryo-HeVol:D841:VolLHe")
  field(INPK, "2.44")
  field(INPL, "Cryo-HeVol:D841:VolGHe")
  field(CALC, "J>0?K*L:0")
  field(FLNK, "Cryo-HeVol:D841:MassHe")
}

record (calc, "Cryo-HeVol:D841:MassHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "Cryo-HeVol:D841:MassLHe")
  field(INPB, "Cryo-HeVol:D841:MassGHe")
  field(CALC, "A+B")
}

record (calc, "Cryo-HeVol:D841:LT-calc:sRdV") {
  field(EGU, "%")
  field(PREC, "1")
  field(SCAN, "10 second")
  field(INPA, "Cryo-HeVol:D841:VolLHe_Lt")
  field(INPB, "0.1")
  field(CALC, "0.1*A/B")
}

# PVs for He balance calculations
####################################

record (calcout, "Cryo-HeVol:D841:InOut-Rst") {
  field(INPA, "Cryo-HeVol:Ctrl:Reset")
  field(CALC, "A=1?1:0")
  field(OUT, "Cryo-HeVol:D841:InOut.OMSL")
  field(FLNK, "Cryo-HeVol:D841:InOut.PROC")
}

record (ao, "Cryo-HeVol:D841:InOut") {
  field(DESC, "Adding/removing from the cryo system")
  field(EGU, "l")
  field(DOL, "Cryo-HeVol:Ctrl:Zero")
  field(UDFS, "NO_ALARM")
  field(FLNK, "Cryo-HeVol:D841:dMassHe.PROC")
}

record (calc, "Cryo-HeVol:D841:dMassHe") {
  field(DESC, "LHe delivery(-) and return (+)")
  field(EGU, "kg")
  field(PREC, "1")
  field(PINI, "YES")
  field(INPA, "-2.19995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPD, "3.6341")
  field(INPE, "9.9234")
  field(INPF, "2.8838")
  field(INPG, "0.1")
  field(INPH, "1000.0")
  field(INPI, "Cryo-HeVol:Ctrl:Reset")
  field(INPJ, "Cryo-HeVol:D841:dMassHe")
  field(INPK, "2.44")
  field(INPL, "Cryo-HeVol:D841:InOut")
  field(CALC, "I=1?0:124.4*L/H+(L=0?0:K*(L>0?G-L/H:-L/H-G))+J")
  info(autosaveFields,"VAL")
  field(FLNK,  "Cryo-HeVol:D841:VolLHe_Lt-sel")
}

record(calc, "Cryo-HeVol:D841:VolLHe_Lt-sel") {
  field(INPA, "Cryo-HeVol:D841:InOut")
  field(CALC, "A=0?0:(A>0?1:3)")
  field(FLNK, "Cryo-HeVol:D841:VolLHe_Lt-calc")
}

record (calc, "Cryo-HeVol:D841:VolLHe_Lt-calc") {
  field(INPA, "Cryo-HeVol:D841:InOut")
  field(INPB, "Cryo-HeVol:D841:Vol") 
  field(SDIS, "Cryo-HeVol:D841:InOut-Rst")
#  field(OUT, "Cryo-HeVol:D841:VolLHe_Lt.VAL CA") 
  field(CALC, "MIN(ABS(A),B*1000.0)")
  field(FLNK, "Cryo-HeVol:D841:VolLHe_Lt-seq")
}

record (seq, "Cryo-HeVol:D841:VolLHe_Lt-seq") {
 field(SELM, "Mask")
 field(SELL, "Cryo-HeVol:D841:VolLHe_Lt-sel")
 field(DOL1, "Cryo-HeVol:D841:VolLHe_Lt-calc")
 field(DOL2, "0.0")
 field(LNK1, "Cryo-HeVol:D841:VolLHe_Lt.VAL PP")
 field(DLY1, "0.0")
 field(LNK2, "Cryo-HeVol:D841:VolLHe_Lt.VAL PP")
 field(DLY2, "11.0")
}
record (ao, "Cryo-HeVol:D590:VolLHe_Lt") {
  field(DESC, "LHe in D590 dewar [l]")
  field(EGU, "l")
  field(PREC, "1")
  field(PINI, "YES")
  info(autosaveFields,"VAL")
  field(FLNK, "Cryo-HeVol:D590:VolLHe")
}

record (calc, "Cryo-HeVol:D590:TT-calc:sRdV") {
  field(EGU, "K")
  field(PREC, "3")
  field(SCAN, "10 second")
  field(INPA, "-0.3193")
  field(INPB, "1.715")
  field(INPC, "2.8012")
  field(INPK, "1.013")
  field(CALC, "A*(K^2)+B*K+C")
}

record (ao, "Cryo-HeVol:D590:Vol") {
  field(DESC, "Volume of D590 portable dewar")
  field(EGU, "m³")
  field(PREC, "3")
  field(VAL, "1.0")
  field(PINI, "YES")
}

record (calc, "Cryo-HeVol:D590:VolLHe") {
#  field(SCAN, "10 second")
#  field(PHAS, "1")
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-HeVol:D590:VolLHe_Lt")
  field(CALC, "A/1000")
  field(FLNK, "Cryo-HeVol:D590:VolGHe")
}

record (calc, "Cryo-HeVol:D590:VolGHe") {
  field(EGU, "m³")
  field(PREC, "3")
  field(INPA, "Cryo-HeVol:D590:VolLHe_Lt")
  field(INPB, "Cryo-HeVol:D590:Vol")
  field(CALC, "A<0.1?0:B-A/1000")
  field(FLNK, "Cryo-HeVol:D590:MassLHe")
}

record (calc, "Cryo-HeVol:D590:MassLHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "-2.19995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPK, "124.4")
  field(INPL, "Cryo-HeVol:D590:VolLHe")
  field(CALC, "K*L")
  field(FLNK, "Cryo-HeVol:D590:MassGHe")
}

# We need to approximate the average density of the He gas in the dewar.
# It depends on the gas temperature distribution in the dewar
# above the LHe. It probably depends on the amount of LHe in the dewar.
# As a first approximation we take assume a constant temperature of the
# gas to be 20 K. The density is then 2.44 kg/m³ at 1013 mbar 

record (calc, "Cryo-HeVol:D590:MassGHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPD, "3.6341")
  field(INPE, "9.9234")
  field(INPF, "2.8838")
  field(INPJ, "Cryo-HeVol:D590:VolLHe")
  field(INPK, "2.44")
  field(INPL, "Cryo-HeVol:D590:VolGHe")
  field(CALC, "J>0?K*L:0")
  field(FLNK, "Cryo-HeVol:D590:MassHe")
}

record (calc, "Cryo-HeVol:D590:MassHe") {
  field(EGU, "kg")
  field(PREC, "1")
  field(INPA, "Cryo-HeVol:D590:MassLHe")
  field(INPB, "Cryo-HeVol:D590:MassGHe")
  field(CALC, "A+B")
}

record (calc, "Cryo-HeVol:D590:LT-calc:sRdV") {
  field(EGU, "%")
  field(PREC, "1")
  field(SCAN, "10 second")
  field(INPA, "Cryo-HeVol:D590:VolLHe_Lt")
  field(INPB, "1.0")
  field(CALC, "0.1*A/B")
}

# PVs for He balance calculations
####################################

record (calcout, "Cryo-HeVol:D590:InOut-Rst") {
  field(INPA, "Cryo-HeVol:Ctrl:Reset")
  field(CALC, "A=1?1:0")
  field(OUT, "Cryo-HeVol:D590:InOut.OMSL")
  field(FLNK, "Cryo-HeVol:D590:InOut.PROC")
}

record (ao, "Cryo-HeVol:D590:InOut") {
  field(DESC, "Adding/removing from the cryo system")
  field(EGU, "l")
  field(DOL, "Cryo-HeVol:Ctrl:Zero")
  field(UDFS, "NO_ALARM")
  field(FLNK, "Cryo-HeVol:D590:dMassHe.PROC")
}

record (calc, "Cryo-HeVol:D590:dMassHe") {
  field(DESC, "LHe delivery(-) and return (+)")
  field(EGU, "kg")
  field(PREC, "1")
  field(PINI, "YES")
  field(INPA, "-2.19995")
  field(INPB, "-15.963")
  field(INPC, "143.59")
  field(INPD, "3.6341")
  field(INPE, "9.9234")
  field(INPF, "2.8838")
  field(INPG, "1.0")
  field(INPH, "1000.0")
  field(INPI, "Cryo-HeVol:Ctrl:Reset")
  field(INPJ, "Cryo-HeVol:D590:dMassHe")
  field(INPK, "2.44")
  field(INPL, "Cryo-HeVol:D590:InOut")
  field(CALC, "I=1?0:124.4*L/H+(L=0?0:K*(L>0?G-L/H:-L/H-G))+J")
  info(autosaveFields,"VAL")
  field(FLNK,  "Cryo-HeVol:D590:VolLHe_Lt-sel")
}

record(calc, "Cryo-HeVol:D590:VolLHe_Lt-sel") {
  field(INPA, "Cryo-HeVol:D590:InOut")
  field(CALC, "A=0?0:(A>0?1:3)")
  field(FLNK, "Cryo-HeVol:D590:VolLHe_Lt-calc")
}

record (calc, "Cryo-HeVol:D590:VolLHe_Lt-calc") {
  field(INPA, "Cryo-HeVol:D590:InOut")
  field(INPB, "Cryo-HeVol:D590:Vol") 
  field(SDIS, "Cryo-HeVol:D590:InOut-Rst")
#  field(OUT, "Cryo-HeVol:D590:VolLHe_Lt.VAL CA") 
  field(CALC, "MIN(ABS(A),B*1000.0)")
  field(FLNK, "Cryo-HeVol:D590:VolLHe_Lt-seq")
}

record (seq, "Cryo-HeVol:D590:VolLHe_Lt-seq") {
 field(SELM, "Mask")
 field(SELL, "Cryo-HeVol:D590:VolLHe_Lt-sel")
 field(DOL1, "Cryo-HeVol:D590:VolLHe_Lt-calc")
 field(DOL2, "0.0")
 field(LNK1, "Cryo-HeVol:D590:VolLHe_Lt.VAL PP")
 field(DLY1, "0.0")
 field(LNK2, "Cryo-HeVol:D590:VolLHe_Lt.VAL PP")
 field(DLY2, "11.0")
}
